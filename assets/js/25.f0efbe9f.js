(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{463:function(a,t,s){a.exports=s.p+"assets/img/w.6732066a.jpg"},464:function(a,t,s){a.exports=s.p+"assets/img/image-20230803174035895.4e1c706a.png"},465:function(a,t,s){a.exports=s.p+"assets/img/image-20230803182031799.72f63805.png"},466:function(a,t,s){a.exports=s.p+"assets/img/image-20230803175530323.17375a3c.png"},669:function(a,t,s){"use strict";s.r(t);var n=s(2),e=Object(n.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[a._v("说明")]),a._v(" "),t("p",[a._v("总览Webpack,Webpack编译原理,Webpack plugin的基本架构，compiler与compilation")])]),a._v(" "),t("h2",{attrs:{id:"webpack基本工作原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#webpack基本工作原理"}},[a._v("#")]),a._v(" webpack基本工作原理")]),a._v(" "),t("p",[t("img",{attrs:{src:s(463),alt:"w"}})]),a._v(" "),t("p",[t("strong",[a._v("依赖分析")])]),a._v(" "),t("p",[a._v("webpack主要功能是从入口文件开始读取文件源码，找到它的依赖。然后读取依赖文件，继续找它们的依赖，一直递归下去。")]),a._v(" "),t("p",[t("strong",[a._v("模块映射")])]),a._v(" "),t("p",[a._v("在依赖分析期间，webpack会进行模块映射，把分析过的文件内容都放在一个map中(大文件)，通过文件路径及文件名相关联的值作为key。")]),a._v(" "),t("p",[t("img",{attrs:{src:s(464),alt:""}})]),a._v(" "),t("h2",{attrs:{id:"生命周期"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#生命周期"}},[a._v("#")]),a._v(" 生命周期")]),a._v(" "),t("p",[a._v("在 Compiler 运行的过程中，webpack 定义了许多生命周期。先放一张总览图（排除 watch 和错误处理）：正是由于有如此多的生命周期开放出来，所以 webpack 的插件机制很强大，可以灵活的介入编译的各个环节")]),a._v(" "),t("p",[t("img",{attrs:{src:s(465),alt:"image-20230803182031799"}})]),a._v(" "),t("h2",{attrs:{id:"插件api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#插件api"}},[a._v("#")]),a._v(" 插件API")]),a._v(" "),t("ul",[t("li",[a._v("compiler: 顶级API，"),t("code",[a._v("Compiler")]),a._v("类的实例，webpack 从开始执行到结束，"),t("code",[a._v("Compiler")]),a._v("只会实例化一次。compiler 对象记录了 webpack 运行环境的所有的信息，插件可以通过它获取到 webpack 的配置信息，如"),t("code",[a._v("entry、output、module")]),a._v("等配置。")]),a._v(" "),t("li",[a._v("compilation: 通过compiler访问，"),t("code",[a._v("Compilation")]),a._v("类实例，提供了 webpack 大部分生命周期Hook API供自定义处理时做拓展使用。一个 compilation 对象记录了一次构建到生成资源过程中的信息，它储存了当前的模块资源、编译生成的资源、变化的文件、以及被跟踪依赖的状态信息。")]),a._v(" "),t("li",[a._v("Resolvers: webpack会把entry的配置路径提供给 Resolver，它会检查给定的部分路径是否存在，并返回完整的绝对路径以及上下文、请求、调用等额外信息。在 "),t("code",[a._v("compiler")]),a._v(" 类中，提供了三种类型的内置解析器："),t("code",[a._v("normal")]),a._v(": 通过绝对或相对路径解析模块；"),t("code",[a._v("context")]),a._v(": 在给定的上下文中解析模块。；"),t("code",[a._v("loader")]),a._v(": 解析 webpack loader。")]),a._v(" "),t("li",[a._v("NormalModuleFactory 与 ContextModuleFactory Hooks: 工厂创建对象或实例。从入口点开始，它解析每个请求，解析内容以查找进一步的请求，并通过解析所有文件和解析任何新文件来继续爬取文件。在最后阶段，每个依赖项都成为一个 Module 实例。")]),a._v(" "),t("li",[a._v("JavascriptParser: 提供模块解释的API，让开发者可以自定义处理模块解释的过程。")])]),a._v(" "),t("h2",{attrs:{id:"tapable"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tapable"}},[a._v("#")]),a._v(" Tapable")]),a._v(" "),t("p",[a._v("基本所有的操作都是通过 Tapable 动态注册回调形成插件机制")]),a._v(" "),t("p",[a._v("Webpack API都继承了Tapable类。Tapable使用发布订阅模式，封装了一系列API控制钩子函数的发布与订阅。")]),a._v(" "),t("p",[a._v("tapable模块下4个类:")]),a._v(" "),t("ul",[t("li",[a._v("SyncHook: 同步钩子，任务会从先到后依次逐个执行。")]),a._v(" "),t("li",[a._v("SyncBailHook: 确保同步钩子，提供终止机制中断钩子任务执行。按顺序执行注册的消费者回调，一旦其中一个消费者return返回值，立刻中断后续执行")]),a._v(" "),t("li",[a._v("AsyncSeriesHook: 异步串行任务钩子。")]),a._v(" "),t("li",[a._v("AsyncParallelHook: 异步并行任务钩子。")])]),a._v(" "),t("h2",{attrs:{id:"compiler-和-compilation"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#compiler-和-compilation"}},[a._v("#")]),a._v(" compiler 和 compilation")]),a._v(" "),t("p",[t("code",[a._v("Compiler")]),a._v(" 模块是 webpack 的主要引擎，它通过 "),t("a",{attrs:{href:"https://www.webpackjs.com/api/cli",target:"_blank",rel:"noopener noreferrer"}},[a._v("CLI"),t("OutboundLink")],1),a._v(" 或者 "),t("a",{attrs:{href:"https://www.webpackjs.com/api/node",target:"_blank",rel:"noopener noreferrer"}},[a._v("Node API"),t("OutboundLink")],1),a._v(" 传递的所有选项创建出一个 compilation 实例。 它扩展（extends）自 "),t("code",[a._v("Tapable")]),a._v(" 类，用来注册和调用插件。 大多数面向用户的插件会首先在 "),t("code",[a._v("Compiler")]),a._v(" 上注册。")]),a._v(" "),t("p",[t("img",{attrs:{src:s(466),alt:"image-20230803175530323"}})]),a._v(" "),t("p",[t("code",[a._v("Compilation")]),a._v("的职责就是对所有 require 图(graph)中对象的字面上的编译，编译构建 module 和 chunk，并调用插件构建过程，同时把本次构建编译的内容全存到内存里。compilation 编译可以多次执行，如在watch模式下启动 webpack，每次监测到源文件发生变化，都会重新实例化一个compilation对象，从而生成一组新的编译资源对象。这个对象可以访问所有的模块和它们的依赖。")]),a._v(" "),t("p",[t("code",[a._v("compiler")]),a._v(" 对象记录着构建过程中 "),t("code",[a._v("webpack")]),a._v(" 环境与配置信息，整个 "),t("code",[a._v("webpack")]),a._v(" 从开始到结束的生命周期。针对的是webpack。")]),a._v(" "),t("p",[t("code",[a._v("compilation")]),a._v(" 对象记录编译模块的信息，只要项目文件有改动，"),t("code",[a._v("compilation")]),a._v(" 就会被重新创建。针对的是随时可变的项目文件。")]),a._v(" "),t("h2",{attrs:{id:"webpack-plugin-的基本架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#webpack-plugin-的基本架构"}},[a._v("#")]),a._v(" webpack plugin 的基本架构")]),a._v(" "),t("p",[a._v("插件需要封装成class，当webpack安装插件时，会对class进行实例化，并调用实例下的"),t("code",[a._v("apply")]),a._v("方法。调用"),t("code",[a._v("apply")]),a._v("方法时候，会把"),t("code",[a._v("compiler")]),a._v("对象作为参数的形式传入，"),t("code",[a._v("compiler")]),a._v("是webpack底层编译对象的引用，开发者可以在"),t("code",[a._v("apply")]),a._v("方法实现中使用"),t("code",[a._v("compiler")]),a._v("。")]),a._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("HelloCompilationPlugin")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("apply")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[a._v("compiler")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 指定一个挂载到 compilation 的钩子，回调函数的参数为 compilation 。")]),a._v("\n    compiler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("hooks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("compilation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tap")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'HelloCompilationPlugin'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[a._v("compilation")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=>")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 现在可以通过 compilation 对象绑定各种钩子")]),a._v("\n      console"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'现在可以通过 compilation 对象绑定各种钩子'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n      compilation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("hooks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("optimize"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tap")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'HelloCompilationPlugin'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=>")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        console"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'资源已经优化完毕。'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\nmodule"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("exports "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" HelloCompilationPlugin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br")])]),t("h2",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[a._v("#")]),a._v(" 参考")]),a._v(" "),t("p",[t("a",{attrs:{href:"https://juejin.cn/post/6969443457450393607",target:"_blank",rel:"noopener noreferrer"}},[a._v("webpack 编译原理(How webpack compiles) - 掘金 (juejin.cn)"),t("OutboundLink")],1)]),a._v(" "),t("p",[t("a",{attrs:{href:"https://juejin.cn/post/6844903573675835400#heading-8",target:"_blank",rel:"noopener noreferrer"}},[a._v("webpack详解 - 掘金 (juejin.cn)"),t("OutboundLink")],1)]),a._v(" "),t("p",[t("a",{attrs:{href:"https://juejin.cn/post/7068482202669056037#heading-2",target:"_blank",rel:"noopener noreferrer"}},[a._v("webpack plugin 从入门到入门 - 掘金 (juejin.cn)"),t("OutboundLink")],1)]),a._v(" "),t("p",[t("a",{attrs:{href:"https://juejin.cn/post/7068930184887402509#comment",target:"_blank",rel:"noopener noreferrer"}},[a._v("webpack plugin 从入门到入门 之compiler与compilation - 掘金 (juejin.cn)"),t("OutboundLink")],1)]),a._v(" "),t("p",[t("a",{attrs:{href:"https://www.webpackjs.com/api/compilation-hooks/",target:"_blank",rel:"noopener noreferrer"}},[a._v("webpack 中文文档 | webpack 中文文档 | webpack 中文网 (webpackjs.com)"),t("OutboundLink")],1)]),a._v(" "),t("p",[a._v("掘金小册 《Webpack5 核心原理与应用实践》")])])}),[],!1,null,null,null);t.default=e.exports}}]);